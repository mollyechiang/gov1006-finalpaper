---
title: "Final Paper"
author: "Chelsea Marlborough"
date: "4/13/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(Hmisc)
library(ggplot2)
library(reshape)
library(AER)
library(grid)
library(plyr)
library(tidyverse)
library(dplyr)

```

```{r loading data, include=FALSE}

set.seed(13)
load("raw-data/spoils_of_victory_replication_data.RData")

options(warn = -1)

```

```{r heteroskedastically robust SE function, include=FALSE}

summaryR.lm <- function(model, type=c("hc3", "hc0", "hc1", "hc2", "hc4"), ...){
  if (!require(car)) stop("Required car package is missing.")
  type <- match.arg(type)
  V <- hccm(model, type=type)
  sumry <- summary(model)
  table <- coef(sumry)
  table[,2] <- sqrt(diag(V))
  table[,3] <- table[,1]/table[,2]
  table[,4] <- 2*pt(abs(table[,3]), df.residual(model), lower.tail=FALSE)
  sumry$coefficients <- table
  p <- nrow(table)
  hyp <- cbind(0, diag(p - 1))
  sumry
}

reais.format <- function(x){
  paste("R\\$", prettyNum(round(x), big.mark = ","), sep =" ")
}

```

```{r discontinuity function,include=FALSE}

discont.plot <- function(y, force.var, cluster, treat,  span = .7, n.boots = 100, bins = 25, xlab = "Forcing Variable", ylab = "Outcome", title="", degree = degree){
  data <- data.frame(y=y, force.var = force.var, cluster.id = cluster, treat = treat)
  clusters <- unique(cluster)
  for(i in 1:n.boots){
    bs.clusters <- data.frame(cluster.id=sample(clusters, replace=TRUE))
    bs.data <- merge(bs.clusters, data,all.x=TRUE,all.y=FALSE, by.x="cluster.id", by.y="cluster.id")
    lo.treat <- loess(y~force.var, data = bs.data[bs.data$treat==1,], span=span, surface="direct", degree = degree)
    lo.control <- loess(y~force.var, data = bs.data[bs.data$treat==0,], span=span, surface="direct", degree = degree)
    lo.fit.treat <- predict(lo.treat, newdata = data$force.var[data$treat==1])
    lo.fit.control <- predict(lo.control, newdata = data$force.var[data$treat==0])
    if(i ==1){
      lo.treat.bs <- matrix(nrow=length(lo.fit.treat), ncol = n.boots)
      lo.control.bs <- matrix(nrow=length(lo.fit.control), ncol = n.boots)
    }
    lo.treat.bs[,i] <- lo.fit.treat
    lo.control.bs[,i] <- lo.fit.control
    if( i %% (0.1 * n.boots) == 0) {  # output progress for each p
      cat(".")
    }
  }
  lo.treat <- loess(y~force.var, data = data[data$treat==1,], span=span, surface="direct", degree = degree)
  lo.control <- loess(y~force.var, data = data[data$treat==0,], span=span, surface="direct", degree = degree)
  lo.fit.treat <- predict(lo.treat, newdata = data$force.var[data$treat==1])
  lo.fit.control <- predict(lo.control, newdata = data$force.var[data$treat==0])
  lo.results.treat <- data.frame(force.var = data$force.var[data$treat==1], y = data$y[data$treat==1], y.fit = lo.fit.treat, conf.hi =  apply(lo.treat.bs,1,quantile,probs=c(.025)), conf.lo =  apply(lo.treat.bs,1,quantile,probs=c(.975)),treat=1)
  lo.results.treat$bin <- sapply(strsplit(gsub("^\\W|\\W$", "", cut(lo.results.treat$force.var, breaks = bins)), ","), function(x)sum(as.numeric(x))/2)
  lo.results.treat <- ddply(lo.results.treat, .(bin), transform, bin.mean = mean(y)) 
  lo.results.control <- data.frame(force.var = data$force.var[data$treat==0], y = data$y[data$treat==0], y.fit = lo.fit.control, conf.hi =  apply(lo.control.bs,1,quantile,probs=c(.025)), conf.lo =  apply(lo.control.bs,1,quantile,probs=c(.975)),treat=0)
  lo.results.control$bin <- sapply(strsplit(gsub("^\\W|\\W$", "", cut(lo.results.control$force.var, breaks = bins)), ","), function(x)sum(as.numeric(x))/2)
  lo.results.control <- ddply(lo.results.control, .(bin), transform, bin.mean = mean(y))
  lo.results <- rbind(lo.results.treat, lo.results.control)
  lo.results$treat <- as.factor(lo.results$treat)
  ggplot(lo.results, aes(x=force.var, y = y.fit, group=treat, color = treat)) + geom_line(aes(y=y.fit), size=1.5)  + geom_vline(xintercept=0) + geom_ribbon(aes(ymin = conf.hi, ymax=conf.lo), alpha =.2)  + geom_point(aes(x=bin, y=bin.mean)) + theme_bw()   + theme(legend.position = "none")  + scale_colour_brewer(palette="Set1")  + scale_x_continuous(xlab) +  scale_y_continuous(ylab) + labs(title = title) + theme(axis.title.x = element_text(vjust = .3)) + theme(plot.title = element_text(size = rel(.9)))
}

```

```{r loess estimating treatment effect function, include=FALSE}

boot.loess <- function(data, index, span = .75, degree = 2){
  boot.data <- data[index,]
  lo.treat <- loess(y~force.var, data = boot.data[boot.data$treat==1,], span=span, surface="direct", degree = degree)
  lo.cont <- loess(y~force.var, data = boot.data[boot.data$treat==0,], span=span, surface="direct", degree = degree)
  lo.fit.tr <- predict(lo.treat, newdata = 0, se = TRUE)
  lo.fit.co <- predict(lo.cont, newdata = 0, se = TRUE)
  c(lo.fit.tr$fit-lo.fit.co$fit, var.t = lo.fit.tr$se.fit + lo.fit.co$se.fit)
}

lo.ate <- function(y, treat, force.var, span = 1, R = 500, degree = 2, replicates = FALSE){
  library(boot)
  data <- data.frame(y, treat, force.var)
  boot.out <- boot(data = data, span = span, statistic = boot.loess, R  = R)
  ci.out <- boot.ci(boot.out, type = "stud")
  lo.treat <- loess(y~force.var, data = data[data$treat==1,], span=span, surface="direct", degree = degree)
  lo.cont <- loess(y~force.var, data = data[data$treat==0,], span=span, surface="direct", degree = degree)
  lo.fit.tr <- predict(lo.treat, newdata = 0)
  lo.fit.co <- predict(lo.cont, newdata = 0)
  if(replicates == TRUE){
    list(est = lo.fit.tr - lo.fit.co, se = sd(boot.out$t[,1]), conf.int = c(ci.out$student[4], ci.out$student[5]), tr.est = lo.fit.tr, con.est = lo.fit.co, boot.replicates = boot.out$t[,1])
  }
  else{
    list(est = lo.fit.tr - lo.fit.co, se = sd(boot.out$t[,1]), conf.int = c(ci.out$student[4], ci.out$student[5]), tr.est = lo.fit.tr, con.est = lo.fit.co)    
  }
}

```

```{r mccrary density test function, include=FALSE}

mccrary.test <- function(force.var, h = .75, n.boots = 1000){
  ##Note that this function assumes that the discontinuity is at 0
  force.below <-force.var[force.var<0]
  force.below <- force.below[force.below>=quantile(force.below, prob=.1)]
  force.above <-force.var[force.var>0]
  force.above <- force.above[force.above<=quantile(force.above, prob=.9)]
  bin.width <- 2 * sd(c(force.above,force.below)) * 1/sqrt(length(c(force.below,force.above)))
  force.below.bin <-  data.frame(table(cut(force.below, breaks = seq(0, min(force.below), by=-1*bin.width ))))
  force.above.bin <- data.frame(table(cut(force.above, breaks = seq(0, max(force.above), by=bin.width ))))
  force.below.bin$Var1 <- sapply(strsplit(gsub("^\\W|\\W$", "", force.below.bin$Var1), ","), function(x)sum(as.numeric(x))/2)
  force.above.bin$Var1 <- sapply(strsplit(gsub("^\\W|\\W$", "", force.above.bin$Var1), ","), function(x)sum(as.numeric(x))/2)
  bin.freq <- rbind(force.below.bin, force.above.bin)
  lo.fit.above <- loess(Freq~Var1, data = bin.freq[bin.freq$Var1>0,], degree=1,span = h)
  lo.fit.below <- loess(Freq~Var1, data = bin.freq[bin.freq$Var1<0,], degree=1,span = h)
  lo.predict <- rbind(data.frame(bin.mid = bin.freq$Var1[bin.freq$Var1<0],  pred.dens = predict(lo.fit.below)),data.frame(bin.mid = bin.freq$Var1[bin.freq$Var1>0],  pred.dens = predict(lo.fit.above)))
  wald.stat <- log(predict(loess(pred.dens~bin.mid, data=lo.predict[lo.predict$bin.mid<0,],span=h,degree=1, surface="direct") ,newdata=data.frame(bin.mid=0))) - log(predict(loess(pred.dens~bin.mid, data=lo.predict[lo.predict$bin.mid>0,],span=h,degree=1, surface="direct") ,newdata=data.frame(bin.mid=0)))
  
  #use the bootstrap to calculate standard error
  log.dis.bs <- matrix(nrow = n.boots)
  for(i in 1:n.boots){
    force.above.bs <- force.above[sample(1:length(force.above), replace = TRUE)]
    force.below.bs <- force.below[sample(1:length(force.below), replace = TRUE)]
    force.below.bs <- force.below.bs[force.below.bs>=quantile(force.below.bs, prob=.1)]
    force.above.bs <- force.above.bs[force.above.bs<=quantile(force.above.bs, prob=.9)]
    bin.width <- 2 * sd(c(force.above.bs,force.below.bs)) * 1/sqrt(length(c(force.below.bs, force.above.bs)))
    force.below.bin <-  data.frame(table(cut(force.below.bs, breaks = seq(0, min(force.below.bs), by=-1*bin.width ))))
    force.above.bin <- data.frame(table(cut(force.above.bs, breaks = seq(0, max(force.above.bs), by=bin.width ))))
    force.below.bin$Var1 <- sapply(strsplit(gsub("^\\W|\\W$", "", force.below.bin$Var1), ","), function(x)sum(as.numeric(x))/2)
    force.above.bin$Var1 <- sapply(strsplit(gsub("^\\W|\\W$", "", force.above.bin$Var1), ","), function(x)sum(as.numeric(x))/2)
    bin.freq <- rbind(force.below.bin, force.above.bin)
    lo.fit.above <- loess(Freq~Var1, data = bin.freq[bin.freq$Var1>0,], degree=1,span = h)
    lo.fit.below <- loess(Freq~Var1, data = bin.freq[bin.freq$Var1<0,], degree=1,span = h)
    lo.predict <- rbind(data.frame(bin.mid = bin.freq$Var1[bin.freq$Var1<0],  pred.dens = predict(lo.fit.below)),data.frame(bin.mid = bin.freq$Var1[bin.freq$Var1>0],  pred.dens = predict(lo.fit.above)))
    
    log.dis.bs[i] <- log(predict(loess(pred.dens~bin.mid, data=lo.predict[lo.predict$bin.mid<0,],span=h,degree=1, surface="direct") ,newdata=data.frame(bin.mid=0))) - log(predict(loess(pred.dens~bin.mid, data=lo.predict[lo.predict$bin.mid>0,],span=h,degree=1, surface="direct") ,newdata=data.frame(bin.mid=0)))
  }
  list(wald.stat = wald.stat, se = sd(log.dis.bs, na.rm = TRUE))  
}

```

```{r number of bootstrap samples, include=FALSE}

num.boots <- 1000

```

```{r parameters for loess estimator, include=FALSE}

span <- 1
lo.degree <- 1

```

